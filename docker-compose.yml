#..... D:\Microservice\Ecommerce Projects\docker-compose.yml .....#



version: "3.8"

services:

  # ===========================
  # Config Server
  # ===========================
  config-server:
    build: ./HyperchipConfigServer
    container_name: config-server
    ports:
      - "8888:8888"
    env_file:
      - .env

  # ===========================
  # Eureka Discovery Server
  # ===========================
  discovery:
    build: ./HyperchipDiscovery
    container_name: discovery
    ports:
      - "8761:8761"
    depends_on:
      - config-server
    env_file:
      - .env

  # ===========================
  # API Gateway
  # ===========================
  api-gateway:
    build: ./HyperchipApiGateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - config-server
      - discovery
    environment:
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: "-Deureka.client.service-url.defaultZone=http://discovery:8761/eureka"

  # ===========================
  # MySQL for Auth Service
  # ===========================
  auth-mysql:
    image: mysql:8
    container_name: auth-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${AUTH_DB_NAME}
      MYSQL_ROOT_PASSWORD: ${AUTH_DB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - auth-db:/var/lib/mysql

  # ===========================
  # Auth Service
  # ===========================

  auth-service:
    build: ./HyperchipAuthService
    container_name: auth-service
    ports:
      - "8084:8080"
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: prod

      # ðŸ”¹ Force Hibernate to CREATE tables
      SPRING_JPA_HIBERNATE_DDL_AUTO: create

      # ðŸ”¹ Database config
      SPRING_DATASOURCE_URL: jdbc:mysql://auth-mysql:3306/${AUTH_DB_NAME}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${AUTH_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${AUTH_DB_PASSWORD}

      # ðŸ”¹ Other service configs
      USER_SERVICE_URL: ${USER_SERVICE_URL}
      USER_SERVICE_SSO_FINISH: ${USER_SERVICE_SSO_FINISH}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD}

      # ðŸ”¹ Force Eureka URL
      JAVA_OPTS: "-Deureka.client.service-url.defaultZone=http://discovery:8761/eureka"

    depends_on:
      - auth-mysql
      - discovery

  # ===========================
  # MySQL for User Service
  # ===========================
  user-mysql:
    image: mysql:8
    container_name: user-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${USER_DB_NAME}
      MYSQL_ROOT_PASSWORD: ${USER_DB_PASSWORD}
    ports:
      - "3308:3306"
    volumes:
      - user-db:/var/lib/mysql

  # ===========================
  # User Service
  # ===========================
  user-service:
    build: ./HyperchipUser
    container_name: user-service
    ports:
      - "8083:8083"
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: prod

      # Database (REQUIRED)
      SPRING_DATASOURCE_URL: jdbc:mysql://user-mysql:3306/${USER_DB_NAME}?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${USER_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${USER_DB_PASSWORD}

      # Force Eureka (REQUIRED â€“ this fixes localhost issue)
      JAVA_OPTS: "-Deureka.client.service-url.defaultZone=http://discovery:8761/eureka"

      # Optional extras (safe)
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD}
      MASTER_SERVICE_URL: ${MASTER_SERVICE_URL}

    depends_on:
      - user-mysql
      - config-server
      - discovery

  # ===========================
  # MySQL for Admin Service
  # ===========================

  admin-mysql:
      image: mysql:8
      container_name: admin-mysql
      restart: always
      environment:
        MYSQL_DATABASE: ${ADMIN_DB_NAME}
        MYSQL_ROOT_PASSWORD: ${ADMIN_DB_PASSWORD}
      ports:
        - "3309:3306"
      volumes:
        - admin-db:/var/lib/mysql


  # ===========================
  # Admin Service
  # ===========================

  admin-service:
        build: ./HyperchipAdmin
        container_name: admin-service
        ports:
          - "8085:8085"
        env_file:
          - .env
        environment:
          SPRING_PROFILES_ACTIVE: prod
          SPRING_JPA_HIBERNATE_DDL_AUTO: create

          SPRING_DATASOURCE_URL: jdbc:mysql://admin-mysql:3306/${ADMIN_DB_NAME}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: ${ADMIN_DB_USER}
          SPRING_DATASOURCE_PASSWORD: ${ADMIN_DB_PASSWORD}

          JAVA_OPTS: "-Deureka.client.service-url.defaultZone=http://discovery:8761/eureka"

        depends_on:
          - admin-mysql
          - discovery
          - config-server





# ===========================
# Volumes
# ===========================
volumes:
  auth-db:
  user-db:
  admin-db:



















