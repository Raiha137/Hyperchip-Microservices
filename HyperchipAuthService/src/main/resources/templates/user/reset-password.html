<!-- templates/user/reset-password.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/png" href="/img/logo-tab.png" sizes="64x64"/>
    <title>Reset Password - Hyperchip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap + FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>

    <!-- Global styles -->
    <link th:href="@{/css/style.css}" rel="stylesheet"/>
    <link th:href="@{/css/login.css}" rel="stylesheet"/>
</head>
<body class="hc-login-body">

<!-- AUTH HEADER -->
<div th:replace="fragments/auth-header :: authHeader"></div>

<section class="hc-login-section">
    <div class="hc-login-overlay"></div>

    <div class="container hc-login-container">
        <div class="row g-5 align-items-center">

            <!-- LEFT SIDE: Info / marketing text -->
            <div class="col-lg-6">
                <div class="hc-login-left">
                    <div class="d-flex align-items-center mb-4">
                        <img th:src="@{/img/logo.png}" alt="Hyperchip Logo" class="hc-login-logo me-2">
                        <span class="hc-login-logo-text">Hyperchip</span>
                    </div>

                    <h1 class="hc-login-title mb-3">Reset your password</h1>

                    <p class="hc-login-subtitle mb-4">
                        Enter the OTP sent to your email and choose a new password.
                        After resetting, you can log in and continue shopping safely.
                    </p>

                    <ul class="hc-login-bullets">
                        <li><i class="fa-solid fa-circle-check"></i> OTP verification for extra security</li>
                        <li><i class="fa-solid fa-circle-check"></i> Your orders &amp; wallet stay safe</li>
                        <li><i class="fa-solid fa-circle-check"></i> You can log in again in seconds</li>
                    </ul>
                </div>
            </div>

            <!-- RIGHT SIDE: Reset Password Form -->
            <div class="col-lg-5 offset-lg-1">
                <div class="hc-login-form-wrapper">
                    <h2 class="hc-login-form-title mb-1">Reset Password</h2>
                    <p class="hc-login-form-subtitle mb-4">
                        Enter OTP and set a new password for your account.
                    </p>

                    <!-- SUCCESS / ERROR MESSAGES -->
                    <div th:if="${successMsg}" class="alert-background alert alert-success text-center mb-3" th:text="${successMsg}"></div>
                    <div th:if="${errorMsg}" class="alert alert-danger text-center mb-3" th:text="${errorMsg}"></div>

                    <form th:action="@{/reset-password}" method="post" id="resetForm"
                          class="hc-login-form inputColor" novalidate>

                        <!-- Hidden email -->
                        <input type="hidden" name="email" th:value="${email}"/>

                        <!-- OTP FIELD -->
                        <div class="mb-3">
                            <label for="otp" class="hc-login-label">Enter OTP</label>
                            <div class="hc-login-input-wrapper">
                                <input type="text" id="otp" name="otp"
                                       class="hc-login-input auth-input"
                                       placeholder="4-digit code" maxlength="4" pattern="\d{4}" required>
                            </div>
                            <small id="otpError" class="hc-field-error"></small>
                        </div>

                        <!-- NEW PASSWORD FIELD -->
                        <div class="mb-3">
                            <label for="newPassword" class="hc-login-label">New Password</label>
                            <div class="hc-login-input-wrapper">
                                <input type="password" id="newPassword" name="password"
                                       class="hc-login-input auth-input"
                                       placeholder="New password" required minlength="6">
                                <span class="hc-login-input-icon toggle-password" data-target="#newPassword">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                            </div>
                            <small id="passwordError" class="hc-field-error"></small>

                            <div class="d-flex justify-content-between mt-1 hc-password-meta">
                                <small class="text-muted">Use at least 8 characters with letters & numbers.</small>
                                <small id="passwordStrength" class="hc-password-strength-label"></small>
                            </div>
                            <div class="hc-password-bar mt-1">
                                <div class="hc-password-bar-fill" id="passwordStrengthBar"></div>
                            </div>
                        </div>

                        <!-- CONFIRM PASSWORD FIELD -->
                        <div class="mb-3">
                            <label for="confirmPassword" class="hc-login-label">Confirm Password</label>
                            <div class="hc-login-input-wrapper">
                                <input type="password" id="confirmPassword" name="confirmPassword"
                                       class="hc-login-input auth-input"
                                       placeholder="Confirm password" required minlength="6">
                                <span class="hc-login-input-icon toggle-password" data-target="#confirmPassword">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                            </div>
                            <small id="confirmError" class="hc-field-error"></small>
                        </div>

                        <!-- CLIENT-SIDE ERROR -->
                        <div id="clientError" class="text-danger mb-2" style="display:none;"></div>

                        <!-- SUBMIT BUTTON -->
                        <button type="submit" class="btn hc-login-btn w-100">Reset Password</button>

                        <!-- BACK TO LOGIN -->
                        <p class="hc-login-bottom mt-3 mb-0 text-center">
                            Remember your password?
                            <a th:href="@{/login}" class="hc-login-link fw-semibold">Back to Login</a>
                        </p>

                    </form>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- AUTH FOOTER -->
<div th:replace="fragments/auth-footer :: authFooter"></div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(function (el) {
        el.addEventListener('click', function () {
            const target = document.querySelector(this.dataset.target);
            if (!target) return;
            const icon = this.querySelector('i');
            if (target.type === 'password') {
                target.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                target.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        });
    });

    // Live OTP validation
    const otpInput = document.getElementById('otp');
    const otpError = document.getElementById('otpError');
    otpInput.addEventListener('input', function () {
        const val = otpInput.value.trim();
        if (!val) otpError.textContent = '';
        else if (!/^\d+$/.test(val)) otpError.textContent = 'OTP should contain only numbers.';
        else if (val.length < 4) otpError.textContent = 'OTP must be exactly 4 digits.';
        else otpError.textContent = '';
    });

    // Password strength meter
    const pwdInput = document.getElementById('newPassword');
    const pwdLabel = document.getElementById('passwordStrength');
    const pwdBar = document.getElementById('passwordStrengthBar');

    function evaluateStrength(pwd) {
        let score = 0;
        if (pwd.length >= 6) score++;
        if (pwd.length >= 8) score++;
        if (/[A-Z]/.test(pwd)) score++;
        if (/[0-9]/.test(pwd)) score++;
        if (/[^A-Za-z0-9]/.test(pwd)) score++;

        if (score <= 1) return {text: 'Weak', percent: 25, color: '#ef4444'};
        if (score === 2) return {text: 'Fair', percent: 40, color: '#f97316'};
        if (score === 3) return {text: 'Good', percent: 70, color: '#eab308'};
        return {text: 'Strong', percent: 100, color: '#22c55e'};
    }

    pwdInput.addEventListener('input', function () {
        const pwd = pwdInput.value;
        if (!pwd) {
            pwdLabel.textContent = '';
            pwdBar.style.width = '0';
            return;
        }
        const result = evaluateStrength(pwd);
        pwdLabel.textContent = result.text;
        pwdBar.style.width = result.percent + '%';
        pwdBar.style.backgroundColor = result.color;
    });

    // Client-side form validation
    document.getElementById('resetForm').addEventListener('submit', function (e) {
        const otp = otpInput.value.trim();
        const p1 = pwdInput.value;
        const p2 = document.getElementById('confirmPassword').value;
        const err = document.getElementById('clientError');

        document.getElementById('passwordError').textContent = '';
        document.getElementById('confirmError').textContent = '';

        if (!/^\d{4}$/.test(otp)) {
            err.style.display = 'block';
            err.textContent = 'Please enter a valid 4-digit OTP.';
            e.preventDefault(); return;
        }
        if (p1.length < 6) {
            document.getElementById('passwordError').textContent = 'Password must be at least 6 characters.';
            err.style.display = 'block';
            err.textContent = 'Please fix the highlighted errors.';
            e.preventDefault(); return;
        }
        if (p1 !== p2) {
            document.getElementById('confirmError').textContent = 'Passwords do not match.';
            err.style.display = 'block';
            err.textContent = 'Please fix the highlighted errors.';
            e.preventDefault(); return;
        }
        err.style.display = 'none';
    });
</script>
</body>
</html>
