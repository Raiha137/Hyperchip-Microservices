<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="icon" type="image/png" href="/img/logo-tab.png" sizes="64x64"/>
    <title>My Account - Hyperchip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .profile-avatar { width:140px; height:140px; object-fit:cover; }
        .section-title { font-weight:600; font-size:1.05rem; }
        .addr-box { border-radius:8px; padding:10px; border:1px solid #eee; }
        .stat-badge { font-size:1.25rem; font-weight:600; }
        .stat-label { font-size:.85rem; color:#666; }
    </style>
</head>
<body>
<div th:replace="fragments/user-header :: userHeader"></div>
<!-- only the page fragment â€” layout will render header/footer -->
<div th:fragment="pageContent" xmlns:th="http://www.thymeleaf.org">
    <div class="container py-4">
        <div th:if="${successMsg}" class="alert alert-success" th:text="${successMsg}"></div>
        <div th:if="${errorMsg}" class="alert alert-danger" th:text="${errorMsg}"></div>
        <div class="row g-4">
            <!-- Left column: profile summary and actions -->
            <div class="col-lg-8">
                <div class="card p-4 shadow-sm mb-4">
                    <div class="d-flex gap-4 align-items-center flex-wrap">
                        <img th:src="${user.profileImage != null ? user.profileImage : '/img/default-profile.png'}"
                             alt="Profile" class="rounded-circle profile-avatar border"/>
                        <div class="flex-grow-1">
                            <h3 class="mb-0" th:text="${user.name}">Full Name</h3>
                            <div class="text-muted" th:text="${user.email}">email@example.com</div>
                            <div class="text-muted" th:text="${user.mobileNumber}">+971-XXXX</div>
                            <div class="mt-3 d-flex gap-2 flex-wrap">
                                <a th:href="@{/user/updateProfile}" class="btn btn-primary">Edit Profile</a>
                                <!-- Correct Change Password -->
                                <a href="http://localhost:8084/forgot-password" class="btn btn-outline-secondary" target="_blank">
                                    Change Password
                                </a>
                                <a th:href="@{/user/address/new}" class="btn btn-outline-primary">Add Address</a>
                                <a th:href="@{/user/orders}" class="btn btn-outline-dark">My Orders</a>
                            </div>
                        </div>
                        <div class="d-none d-md-block text-end">
                            <a th:href="@{/user/updateProfile}" class="btn btn-sm btn-outline-secondary mb-2">Edit</a>
                            <form th:action="@{/logout}" method="post" class="d-inline">
                                <button class="btn btn-sm btn-outline-danger">Logout</button>
                            </form>
                        </div>
                    </div>
                    <hr class="my-4"/>
                    <!-- Optional: small profile stats or short bio could go here -->
                </div>
                <div class="card p-3 shadow-sm">
                    <div class="section-title">Quick actions</div>
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <a th:href="@{/user/address}" class="btn btn-outline-dark">Manage addresses</a>
                        <a th:href="@{/user/wishlist}" class="btn btn-outline-dark">Wishlist</a>
                        <a th:href="@{/contact}" class="btn btn-outline-dark">Contact support</a>
                        <a th:href="@{/user/orders}" class="btn btn-outline-dark">Orders</a>
                    </div>
                </div>
            </div>
            <!-- Right column: account summary + addresses (NO profile duplicate) -->
            <div class="col-lg-4">
                <div class="card p-3 shadow-sm mb-3">
                    <div class="section-title">Account summary</div>
                    <div class="list-group list-group-flush">
                        <a th:href="@{/user/orders}" class="list-group-item list-group-item-action">Orders</a>
                        <a th:href="@{/user/wishlist}" class="list-group-item list-group-item-action">Wishlist</a>
                        <a th:href="@{/user/cart}" class="list-group-item list-group-item-action">Cart</a>
                        <a th:href="@{/user/products}" class="list-group-item list-group-item-action">Products</a>
                        <a th:href="@{/user/referral}" class="list-group-item list-group-item-action">My Coupons</a>
                        <a th:href="@{/user/my-coupons}" class="list-group-item list-group-item-action">Referral</a>
                        <form th:action="@{/logout}" method="post" class="m-0">
                            <button type="submit" class="list-group-item list-group-item-action">Logout</button>
                        </form>
                    </div>
                </div>
                <div class="card p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="section-title">Saved addresses</div>
                        <a th:href="@{/user/address/new}" class="btn btn-sm btn-primary">Add</a>
                    </div>
                    <div class="mt-3">
                        <div th:if="${addresses == null || #lists.isEmpty(addresses)}" class="text-muted">No saved addresses.</div>
                        <div th:if="${addresses != null && !#lists.isEmpty(addresses)}">
                            <div th:each="addr : ${addresses}" class="addr-box mb-3">
                                <div class="fw-semibold" th:text="${addr.label}">Home</div>
                                <div class="small text-muted" th:text="${addr.addressLine1 + (addr.addressLine2 != null ? (', ' + addr.addressLine2) : '')}">Address lines</div>
                                <div class="small text-muted" th:text="${addr.city + ', ' + addr.state}">City</div>
                                <div class="mt-2 d-flex gap-2">
                                    <a th:href="@{|/user/address/${addr.id}/edit|}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                    <form th:action="@{|/user/address/${addr.id}/delete|}" method="post" onsubmit="return confirm('Delete address?');">
                                        <button class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- change password modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="changePasswordForm" th:action="@{/user/change-password}" method="post" class="modal-content" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title">Change password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current password</label>
                        <input type="password" name="currentPassword" class="form-control" required minlength="6" />
                        <div class="invalid-feedback">Current password is required (min 6 characters).</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New password</label>
                        <input type="password" name="newPassword" class="form-control" minlength="6" required />
                        <div class="form-text">Password must be at least 6 characters.</div>
                        <div class="invalid-feedback">New password must be at least 6 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm password</label>
                        <input type="password" name="confirmPassword" class="form-control" minlength="6" required />
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="changePasswordSubmit" type="submit" class="btn btn-primary">Change</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div th:replace="fragments/user-footer :: userFooter"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Client-side validation for the change-password form (keeps server-side intact)
    (function(){
      document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('changePasswordForm');
        if (!form) return;
        var current = form.querySelector('[name="currentPassword"]');
        var np = form.querySelector('[name="newPassword"]');
        var cp = form.querySelector('[name="confirmPassword"]');

        function clearErrors() {
          [current, np, cp].forEach(function (el) {
            if (!el) return;
            el.classList.remove('is-invalid');
          });
        }

        function validate() {
          clearErrors();
          var ok = true;
          if (!current || current.value.trim().length < 6) {
            current && current.classList.add('is-invalid');
            ok = false;
          }
          if (!np || np.value.trim().length < 6) {
            np && np.classList.add('is-invalid');
            ok = false;
          }
          if (!cp || np.value !== cp.value) {
            cp && cp.classList.add('is-invalid');
            ok = false;
          }
          return ok;
        }

        form.addEventListener('submit', function (e) {
          if (!validate()) {
            e.preventDefault();
            e.stopPropagation();
          }
        });

        [current, np, cp].forEach(function (el) {
          if (!el) return;
          el.addEventListener('input', function () {
            // remove invalid state while user types
            if (el.classList.contains('is-invalid')) el.classList.remove('is-invalid');
          });
        });
      });
    })();
</script>
</body>
</html>