<!--order-detail.html-->

<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" type="image/png" href="/img/logo-tab.png" sizes="64x64"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>My Orders - Hyperchip</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <link rel="stylesheet" th:href="@{/css/style.css}" />

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"/>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- small page-specific adjustments to align buttons/status -->
    <style>
        /* Ensure actions align vertically and horizontally */
        .order-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
        .status-pill { display:inline-block; padding:6px 10px; border-radius:12px; background:#f0f0f0; font-weight:600; }
        .thumbs-col img { width:100%; height:100%; object-fit:cover; border-radius:6px; }
        .order-card { border-radius:10px; }
        .product-title-line{color:#000;}
        .order-payment-value,
        .order-shipping-value {
            color: #000;
            font-weight: 600;
        }
        .text-end .fw-semibold{
            color: #000;
        }
        .items-txt{
            color: #000;
        }
        .item-cancelled {
            opacity: 0.55;
            pointer-events: none;
        }

    </style>
</head>
<body>
<div th:replace="fragments/user-header :: userHeader"></div>
<div th:fragment="pageContent">

    <div class="container my-5">
        <input type="hidden" id="page-order-id" th:value="${orderId}" />
        <div id="order-area">
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <div class="mt-2 small text-muted">Loading order...</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="cancelFormDetail" class="modal-content" onsubmit="return false;">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cancel-order-id-detail" />
                    <input type="hidden" id="cancel-item-id-detail" />
                    <div class="mb-2">Please select a reason (optional):</div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cancelReasonD" id="d1" value="Changed my mind">
                        <label class="form-check-label" for="d1">Changed my mind</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cancelReasonD" id="d2" value="Found better price">
                        <label class="form-check-label" for="d2">Found better price</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cancelReasonD" id="d3" value="Product size/fit issue">
                        <label class="form-check-label" for="d3">Product size/fit issue</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cancelReasonD" id="d4" value="Other">
                        <label class="form-check-label" for="d4">Other</label>
                    </div>
                    <div class="mt-2">
                        <textarea id="cancel-other-detail" class="form-control" rows="2" placeholder="If other, provide details..." disabled></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="confirm-cancel-order-detail" type="button" class="btn btn-danger">Cancel Order</button>
                </div>
            </form>
        </div>
    </div>
    <div th:replace="fragments/user-footer :: userFooter"></div>


</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- inline JS kept as-is (th:inline) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    (function () {
        const orderIdEl = document.getElementById('page-order-id');
        const orderId = orderIdEl ? orderIdEl.value : null;
        const area = document.getElementById('order-area');

        if (!orderId || orderId === 'undefined' || orderId === 'null') {
            window.location.href = '/user/orders';
            return;
        }

        function formatMoney(val) {
            const num = Number(val || 0);
            return num.toFixed(2);
        }

        function formatDate(val) {
            if (!val) return '';
            try {
                const d = new Date(val);
                if (!isNaN(d.getTime())) return d.toLocaleString();
            } catch (e) {}
            return String(val);
        }

        function getOrderPlacedDate(order) {
            if (!order) return 'â€”';
            const c = order.createdAt || order.createdOn || order.orderDate || order.placedAt || order.placedOn;
            return c ? formatDate(c) : 'â€”';
        }

        function getItems(order) {
            if (!order) return [];
            if (Array.isArray(order.items)) return order.items;
            if (Array.isArray(order.orderItems)) return order.orderItems;
            return [];
        }

        function getItemImage(it) {
            if (!it) return '/img/default-product.png';
            if (typeof it.productImage === 'string' && it.productImage.trim() !== '') return it.productImage;
            if (typeof it.imageUrl === 'string' && it.imageUrl.trim() !== '') return it.imageUrl;
            if (typeof it.image === 'string' && it.image.trim() !== '') return it.image;
            return '/img/default-product.png';
        }

        function getItemTitle(it) {
            if (!it) return 'Product';
            return (
                it.productTitle ||
                it.productName ||
                it.title ||
                (it.productId ? 'Product #' + it.productId : 'Product')
            );
        }

        function safeOrderId(order) {
            if (!order) return null;
            const raw = order.id || order.orderId || order.orderNumber || order.externalId;
            return raw != null ? String(raw) : null;
        }

        function showSuccessPopup(message) {
            // If SweetAlert2 is available (used in other pages)
            if (window.Swal) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: message,
                    confirmButtonColor: '#198754'
                });
            } else {
                // fallback (just in case)
                alert(message);
            }
        }


        async function loadOrder() {
            area.innerHTML =
                '<div class="text-center py-4">' +
                '<div class="spinner-border"></div>' +
                '<div class="mt-2 small text-muted">Loading...</div>' +
                '</div>';

            try {
                const res = await fetch(
                    '/user/api/proxy/orders/' + encodeURIComponent(orderId) + '?_=' + Date.now(),
                    { credentials: 'same-origin' }
                );

                if (!res.ok) {
                    area.innerHTML = '<div class="alert alert-danger">Order not found.</div>';
                    return;
                }

                const data = await res.json();
                const order = data && data.order ? data.order : data;

                const status = (order.status || '').toUpperCase();
                const placedDate = getOrderPlacedDate(order);
                const safeId = safeOrderId(order);

                const items = getItems(order);


                const itemsHtml = items.length
                    ? items
                          .map((it) => {
                              const img = getItemImage(it);
                              const title = getItemTitle(it);
                              const qty = it.quantity != null ? it.quantity : 0;
                              const total = formatMoney(it.total || (it.unitPrice || 0) * qty);

                              // ðŸ”¹ check if this item is already cancelled
                              const isCancelled = it.cancelled === true;

                              // ðŸ”¹ Only show "Cancel item" button if NOT already cancelled
                              const canCancelItem =
                                  !isCancelled &&
                                  (status === 'PENDING' || status === 'CONFIRMED') &&
                                  it.id != null;

                              // ðŸ”¹ Small badge next to title if cancelled
                              const statusBadgeHtml = isCancelled
                                  ? '<span class="badge cancelled-badge ms-2">Cancelled</span>'
                                  : '';

                              return `
                <div class="row align-items-center mb-4 item-row ${isCancelled ? 'item-cancelled' : ''}">
                    <div class="col-auto">
                        <img src="${img}" alt="product" class="img-thumbnail" style="width:120px;height:120px;object-fit:cover;">
                    </div>
                    <div class="col">
                        <div class="fw-bold product-title-line">
                            ${title}
                            ${statusBadgeHtml}
                        </div>
                        <div class="text-muted small">Quantity: ${qty}</div>
                        ${
                            canCancelItem
                                ? `<button type="button"
                                           class="btn btn-outline-danger btn-sm item-cancel-btn"
                                           data-order-id="${safeId || order.id}"
                                           data-item-id="${it.id}">
                                       Cancel item
                                   </button>`
                                : ''
                        }
                    </div>
                    <div class="col-auto text-end">
                        <div class="fw-semibold">â‚¹ ${total}</div>
                    </div>
                </div>
              `;
                          })
                          .join('')
                    : '<div class="text-muted small">No items</div>';

                const invoiceDisabledAttr = safeId ? '' : 'disabled';

                area.innerHTML = `
                    <div class="card p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="order-number">Order #${order.orderNumber || order.id || ''}</h4>
                                <div class="text-muted small">Placed: ${placedDate}</div>
                            </div>
                            <div class="text-end">
                                <div class="badge-status bg-light text-dark">${order.status || 'â€”'}</div>
                                <div class="mt-2">
                                    <strong>Total: â‚¹${formatMoney(order.total || order.totalAmount || order.subtotal)}</strong>
                                </div>
                            </div>
                        </div>

                        <hr/>

                        <h5 class="mb-3 items-txt">Items</h5>
                        ${itemsHtml}

                        <hr/>

                        <div class="d-flex justify-content-between flex-wrap gap-3">
                            <div>
                                <div class="small text-muted">Payment method</div>
                                <div class="order-payment-value">
                                    ${order.paymentMethod || 'COD'}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="small text-muted">Shipping</div>
                                <div class="order-shipping-value">
                                    â‚¹ ${formatMoney(order.shipping || order.shippingFee || 0)}
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
    ${
        status === 'PENDING' || status === 'CONFIRMED'
            ? `<button class="btn btn-danger me-auto" id="cancel-btn">Cancel order</button>`
            : ''
    }

    ${ status === 'DELIVERED'
        ? `<div class="me-auto d-flex gap-2">
              <button class="btn btn-outline-warning" id="return-btn">Request Return</button>
              <button class="btn btn-outline-info" id="replacement-btn">Request Replacement</button>
           </div>`
        : ''
    }

    <a class="btn btn-outline-secondary" href="/user/orders">
        Back to orders
    </a>

    <button class="btn btn-primary" id="invoice-btn" ${invoiceDisabledAttr}>
        Download Invoice
    </button>
</div>

                    </div>
                `;

                // Whole order cancel button
                if (status === 'PENDING' || status === 'CONFIRMED') {
                    const btn = document.getElementById('cancel-btn');
                    if (btn && safeId) {
                        btn.addEventListener('click', function () {
                            document.getElementById('cancel-order-id-detail').value = safeId;
                            document.getElementById('cancel-item-id-detail').value = ''; // whole order

                            const modalEl = document.getElementById('cancelModal');
                            const bs = bootstrap.Modal.getOrCreateInstance(modalEl);

                            document
                                .querySelectorAll('#cancelModal input[name="cancelReasonD"]')
                                .forEach((r) => (r.checked = false));
                            const other = document.getElementById('cancel-other-detail');
                            other.value = '';
                            other.disabled = true;

                            bs.show();
                        });
                    }
                }

                // Per-item cancel buttons (delegate on order-area)
                area.addEventListener('click', function (ev) {
                    const target = ev.target;
                    if (!target.classList.contains('item-cancel-btn')) return;

                    const oId = target.getAttribute('data-order-id');
                    const itemId = target.getAttribute('data-item-id');
                    if (!oId || !itemId) return;

                    document.getElementById('cancel-order-id-detail').value = oId;
                    document.getElementById('cancel-item-id-detail').value = itemId;

                    const modalEl = document.getElementById('cancelModal');
                    const bs = bootstrap.Modal.getOrCreateInstance(modalEl);

                    document
                        .querySelectorAll('#cancelModal input[name="cancelReasonD"]')
                        .forEach((r) => (r.checked = false));
                    const other = document.getElementById('cancel-other-detail');
                    other.value = '';
                    other.disabled = true;

                    bs.show();
                });

                // Invoice download
                const inv = document.getElementById('invoice-btn');
                if (inv) {
                    inv.addEventListener('click', function () {
                        if (!safeId) {
                            alert('Invoice not available for this order');
                            return;
                        }
                        window.location = '/user/api/proxy/orders/' + encodeURIComponent(safeId) + '/invoice';
                    });
                }

// ----------------- Return / Replacement: redirect to full pages -----------------
document.addEventListener('click', function (ev) {
    // Redirect to your existing full-page return form
    if (ev.target && ev.target.id === 'return-btn') {
        if (!safeId) {
            showSuccessPopup('Order not available');
            return;
        }
        // go to your return request page (server will render the form)
        window.location.href = '/user/order/return-request?orderId=' + encodeURIComponent(safeId);
    }

    // Redirect to your existing full-page replacement form
    if (ev.target && ev.target.id === 'replacement-btn') {
        if (!safeId) {
            showSuccessPopup('Order not available');
            return;
        }
        // go to your replacement request page
        window.location.href = '/user/order/replacement-request?orderId=' + encodeURIComponent(safeId);
    }
});

            } catch (e) {
                console.error('Error loading order', e);
                area.innerHTML = '<div class="alert alert-danger">Error loading order.</div>';
            }
        }

        // Enable/disable "Other" text box in cancel modal
        document.addEventListener('change', function (ev) {
            if (ev.target && ev.target.name === 'cancelReasonD') {
                const other = document.getElementById('cancel-other-detail');
                if (!other) return;
                if (ev.target.value === 'Other') {
                    other.disabled = false;
                } else {
                    other.disabled = true;
                    other.value = '';
                }
            }
        });




        // Confirm cancel (whole order or single item)
      document
    .getElementById('confirm-cancel-order-detail')
    .addEventListener('click', async function () {
        const orderIdVal = document.getElementById('cancel-order-id-detail').value;
        const itemIdVal = document.getElementById('cancel-item-id-detail').value;

        if (!orderIdVal || orderIdVal === 'undefined') return;

        let reasonRadio = document.querySelector(
            '#cancelModal input[name="cancelReasonD"]:checked'
        );
        let reason = reasonRadio ? reasonRadio.value : '';
        if (reason === 'Other') {
            const otherText = document.getElementById('cancel-other-detail').value;
            reason = otherText || 'Other';
        }

        let url;
        if (itemIdVal) {
            // cancel single item
            url =
                '/user/api/proxy/orders/' +
                encodeURIComponent(orderIdVal) +
                '/items/' +
                encodeURIComponent(itemIdVal) +
                '/cancel?reason=' +
                encodeURIComponent(reason || '');
        } else {
            // cancel whole order
            url =
                '/user/api/proxy/orders/' +
                encodeURIComponent(orderIdVal) +
                '/cancel?reason=' +
                encodeURIComponent(reason || '');
        }

        try {
            const r = await fetch(url, {
                method: 'POST',
                credentials: 'same-origin'
            });

            if (!r.ok) {
                const text = await r.text().catch(() => r.statusText);
                alert('Cancel failed: ' + (text || r.statusText));
               } else {
    if (itemIdVal) {
        // ================= SINGLE ITEM CANCELLED =================

        // 1) Show nice popup with tick
        showSuccessPopup('Your item has been cancelled successfully.');

        // 2) Hide the cancel modal
        const modalEl = document.getElementById('cancelModal');
        const bsModal = bootstrap.Modal.getInstance(modalEl);
        if (bsModal) bsModal.hide();

        // 3) Find the correct item row in the UI
        const row = document
            .querySelector(`button[data-item-id="${itemIdVal}"]`)
            ?.closest('.item-row');

        if (row) {
            // Make row look inactive
            row.classList.add('item-cancelled');

            // Remove the cancel button
            const btn = row.querySelector('.item-cancel-btn');
            if (btn) btn.remove();

            // Add a "Cancelled" badge next to the product title
            const titleDiv = row.querySelector('.product-title-line');
            if (titleDiv && !titleDiv.querySelector('.cancelled-badge')) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary ms-2 cancelled-badge';
                badge.textContent = 'Cancelled';
                titleDiv.appendChild(badge);
            }
        }

        // IMPORTANT: stop here (no reload / redirect)
        return;
    } else {
        // ================= WHOLE ORDER CANCELLED =================

        // Popup with tick
        showSuccessPopup('Your order has been cancelled successfully.');

        // Small delay so user can see popup, then go back to orders list
        setTimeout(function () {
            window.location.href = '/user/orders?cancelSuccess=1';
        }, 1200);
    }
}





        } catch (e) {
            console.error('Cancel failed', e);
            alert('Cancel failed');
        }
    });




        // finally load the order
        loadOrder();
    })();
     /*]]>*/

</script>

<!-- keep external JS include if you have fallback file; safe to keep even after inline script -->
<script th:src="@{/js/order-detail.js}"></script>


<!-- ==== Toast popup for success messages ==== -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
    <div id="hcToast"
         class="toast align-items-center text-bg-success border-0"
         role="alert"
         aria-live="assertive"
         aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="hcToastBody">
                <!-- message will be filled from JS -->
                Action completed.
            </div>
            <button type="button"
                    class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"
                    aria-label="Close"></button>
        </div>
    </div>
</div>


</body>
</html>
