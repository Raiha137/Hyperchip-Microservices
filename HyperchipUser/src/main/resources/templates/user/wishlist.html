<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="icon" type="image/png" href="/img/logo-tab.png" sizes="64x64"/>
    <title>Wishlist - Hyperchip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .card { border-radius: 12px; }
        .product-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .wishlist-area .fw-bold{
        color: #000;
        }
        .wishlist-title .fw-bold{
        color: #000;
        }
    </style>
</head>
<body>
<div th:replace="fragments/user-header :: userHeader"></div>
<div class="container my-5 wishlist">
    <input type="hidden" id="page-user-id" th:value="${userId}" />
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Your Wishlist</h3>
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/user/products}" href="/user/products">Continue Shopping</a>
    </div>
    <div id="wishlist-area">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-3">Loading wishlist...</div>
        </div>
    </div>
</div>
<div th:replace="fragments/user-footer :: userFooter"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    (() => {
        const userIdEl = document.getElementById('page-user-id');
        const userId = userIdEl ? (userIdEl.value || '').trim() : '';
        // IMPORTANT: this matches your frontend calls. Keep the /user prefix if your app uses it in URLs.
        const apiBase = '/user/api/wishlist/' + encodeURIComponent(userId);

        function formatMoney(v){ return '₹ ' + (Number(v) || 0).toFixed(2); }
        function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

        async function loadWishlist(){
            try {
                const res = await fetch(apiBase, { credentials: 'same-origin' });
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                renderList(Array.isArray(list) ? list : (list.items || []));
            } catch(e){
                console.error(e);
                document.getElementById('wishlist-area').innerHTML =
                    '<div class="alert alert-danger text-center">Failed to load wishlist.</div>';
            }
        }

        function renderList(items){
            if (!items || items.length === 0) {
                document.getElementById('wishlist-area').innerHTML = `
                    <div class="card p-4 text-center">
                        <h5 class="mb-3">Your wishlist is empty</h5>
                        <a class="btn btn-outline-primary" href="/user/products">Shop now</a>
                    </div>`;
                return;
            }

            const html = items.map(it => {
                const img = escapeHtml(it.productImage || '/img/default-product.png');
                const title = escapeHtml(it.productTitle || 'Unknown Product');
                const price = formatMoney(it.unitPrice);
                const pid = it.productId;
                const qty = Math.max(0, Math.min(3, Number(it.quantity) || 0)); // ensure 0..3

                return `<div class="card mb-3 p-3" data-product="${pid}">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto"><img src="${img}" class="product-thumb" alt="${title}"/></div>
                        <div class="col wishlist-title">
                            <div class="fw-bold">${title}</div>
                            <div class="text-muted small">${price}</div>
                        </div>
                        <div class="col-auto d-flex align-items-center gap-2">
                            <div class="input-group input-group-sm" style="width:120px;">
                                <button class="btn btn-outline-secondary btn-sm qty-decr" data-id="${pid}" ${qty<=0?'disabled':''}>−</button>
                                <input type="text" readonly class="form-control form-control-sm text-center qty-value" value="${qty}" data-id="${pid}" />
                               <button class="btn btn-outline-secondary btn-sm qty-incr"
        data-id="${pid}">+</button>

                            </div>
                            <div class="d-flex flex-column">
                                <button class="btn btn-sm btn-primary move-to-cart" data-id="${pid}"><i class="fa fa-cart-plus"></i> Add to Cart</button>
                                <button class="btn btn-sm btn-outline-danger remove-wish mt-1" data-id="${pid}"><i class="fa fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            const area = document.getElementById('wishlist-area');
            area.innerHTML = html;

            // wire events
            area.querySelectorAll('.remove-wish').forEach(btn => btn.onclick = () => removeItem(btn.dataset.id));
            area.querySelectorAll('.move-to-cart').forEach(btn => btn.onclick = () => moveToCart(btn.dataset.id));
            area.querySelectorAll('.qty-incr').forEach(btn => btn.onclick = () => changeQty(btn.dataset.id, +1));
            area.querySelectorAll('.qty-decr').forEach(btn => btn.onclick = () => changeQty(btn.dataset.id, -1));
        }

        async function changeQty(productId, delta){
            try {
                const input = document.querySelector(`.qty-value[data-id='${productId}']`);
                let cur = input ? Number(input.value || 0) : 0;
                const next = cur + delta;
                if (next < 0 || next > 3) {
                    Swal.fire({ icon: 'warning', title: 'Limit', text: 'You can keep maximum 3 of same product.', timer: 1200, showConfirmButton:false });
                    return;
                }

                toggleQtyControls(productId, true);

                // POST to safe updateQuantity endpoint (server side must implement POST /updateQuantity)
                const body = { quantity: next };
                const r = await fetch(`${apiBase}/items/${productId}/updateQuantity`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify(body)
                });

                if (!r.ok) {
                    let text = await r.text();
                    try { const obj = JSON.parse(text); throw new Error(obj.error || text); } catch(e){ throw new Error(text || r.statusText); }
                }

                // refresh wishlist so UI and server stay in sync
                await loadWishlist();
            } catch(e){
                console.error(e);
                Swal.fire({ icon: 'error', title: 'Update failed', text: e.message || 'Could not update quantity' });
                toggleQtyControls(productId, false);
            }
        }

        function toggleQtyControls(productId, disable){
            const incr = document.querySelector(`.qty-incr[data-id='${productId}']`);
            const decr = document.querySelector(`.qty-decr[data-id='${productId}']`);
            const input = document.querySelector(`.qty-value[data-id='${productId}']`);
            if (incr) incr.disabled = disable || incr.disabled;
            if (decr) decr.disabled = disable || decr.disabled;
            if (input) input.readOnly = disable;
        }

        async function removeItem(productId){
            try {
                const r = await fetch(`${apiBase}/items/${productId}`, { method: 'DELETE', credentials: 'same-origin' });
                if (r.ok) {
                    await loadWishlist();
                    Swal.fire({ icon: 'success', title: 'Removed from wishlist', timer: 1000, showConfirmButton: false });
                } else {
                    let text = await r.text();
                    Swal.fire({ icon: 'error', title: 'Failed to remove', text: text || r.statusText });
                }
            } catch(e){
                Swal.fire({ icon: 'error', title: 'Failed to remove', text: e.message || e });
            }
        }

        async function moveToCart(productId){
            try {
                const qtyInput = document.querySelector(`.qty-value[data-id='${productId}']`);
                const quantityToMove = qtyInput ? Number(qtyInput.value || 1) : 1;

                const payload = { userId: Number(userId), productId: Number(productId), quantity: Number(quantityToMove) };
                const r = await fetch('/user/api/cart/add', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });
                if (!r.ok) {
                    let text = await r.text();
                    try { const obj = JSON.parse(text); throw new Error(obj.error || text); } catch(e) { throw new Error(text || r.statusText); }
                }

                // after moving to cart remove from wishlist
                await removeItem(productId);
                Swal.fire({ icon: 'success', title: 'Moved to cart', timer: 1000, showConfirmButton: false });
            } catch(e){
                Swal.fire({ icon: 'error', title: 'Add to cart failed', text: e.message || 'Failed' });
            }
        }

        if (userId) loadWishlist();
        else document.getElementById('wishlist-area').innerHTML = '<div class="alert alert-warning">Please sign in to view your wishlist.</div>';
    })();
    /*]]>*/
</script>
</body>
</html>