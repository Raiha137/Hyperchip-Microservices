<!--templates/user/product-detail.html-->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/img/logo-tab.png" sizes="64x64"/>
    <title th:text="${product.title != null ? product.title + ' - Hyperchip' : 'Product Detail - Hyperchip'}">Product Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom/dist/drift-basic.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .badge-discount {
        position: relative;
        padding: .35rem .7rem;
        border-radius: 999px;
        font-size: .8rem;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #fff;
        box-shadow: 0 6px 18px rgba(22, 163, 74, 0.35);
        letter-spacing: .03em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: .3rem;
        }
        .badge-discount i { font-size: .8rem; }
        .txt-black h6,p{ color: #000; }
        .hc-related-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        }
        .pd-price-main { display: flex; align-items: baseline; gap: 4px; margin-bottom: 0.25rem; }
        .pd-price-currency { font-size: 0.9rem; font-weight: 600; position: relative; top: -10px; margin-right:-4px; }
        .pd-price-current { font-size: 2rem; font-weight: 700; color: #000; }
        .pd-price-extra { display: flex; align-items: center; gap: 0.5rem; }
        .pd-price-original { font-size: 0.9rem; color: #6c757d; text-decoration: line-through; }
        .pd-price-save { font-size: 0.85rem; color: #198754; }
        .thumb-img.active { outline: 2px solid #f59e0b; }
        .small-currency
        {
        font-size: 0.7rem;
        top: -4px;
        margin-right: -4px;}
        .related-product
        .pd-price-currency {
        font-size: 0.59rem;
        font-weight: 600;
        position: relative;
        top: -6px;
        margin-right: -5px;
        margin-top: -10px;
        }
        .related-product .text-muted{
        padding-left: 10px;
        }
        .related-product    .small-currency {
        font-size: 0.5rem;
        top: -4px;
        margin-right: -4px;
        }
        /* Brand (Noon-style) */
        .pd-brand-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
        font-weight: 600;
        }
        .pd-brand-badge {
        background-color: #2563EB;   /* Royal Blue */
        color: #fff;
        font-size: 0.65rem;
        padding: 4px 6px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        }
        .pd-brand-text {
        color: #2563EB;
        }
        .pd-brand-link:hover .pd-brand-text {
        text-decoration: underline;
        }
        /* ===== Product header layout fix ===== */
        /* allow wrapping again */
        .d-flex.align-items-center.gap-2.mb-1 {
        flex-wrap: wrap;
        }
        /* BRAND → force first line */
        .pd-brand-link {
        width: 100%;
        }
        /* TITLE + OFFER → second line layout */
        .d-flex.align-items-center.gap-2.mb-1 h2 {
        flex: 1;
        margin-top: 4px;
        }
        /* OFFER BADGE → right side of title */
        .badge-discount {
        white-space: nowrap;
        margin-left: auto;
        margin-top: 6px;
        }
    </style>
</head>
<body>
<div th:replace="fragments/user-header :: userHeader"></div>
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
            <li class="breadcrumb-item"><a th:href="@{/user/products}">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${product.title}">Product</li>
        </ol>
    </nav>
    <div class="row gx-5">
        <div class="col-lg-6">
            <div class="zoom-container p-3 bg-white rounded" id="zoomContainer">
                <img th:if="${product.imageNames != null and !#lists.isEmpty(product.imageNames)}"
                     th:src="${masterBaseUrl + '/uploads/products/' + product.imageNames[0]}"
                     id="mainProductImage" class="zoomable img-fluid" th:alt="${product.title}" />
                <img th:if="${product.imageNames == null or #lists.isEmpty(product.imageNames)}"
                     th:src="@{/img/default-product.png}" id="mainProductImage" class="zoomable img-fluid" alt="No Image Available" />
            </div>
            <div class="d-flex gap-2 flex-wrap mt-3" th:if="${product.imageNames != null and !#lists.isEmpty(product.imageNames)}">
                <img th:each="img, stat : ${product.imageNames}"
                     th:src="${masterBaseUrl + '/uploads/products/' + img}"
                     class="thumb-img img-thumbnail"
                     th:classappend="${stat.index == 0} ? ' active' : ''"
                     onclick="updateMainImage(this)" alt="thumbnail" style="width:72px;height:72px;object-fit:cover;"/>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
                <!-- BRAND (simple, no extra containers) -->
                <a th:if="${product.brandName != null}"
                   th:href="@{/user/products(brand=${product.brandName})}"
                   class="pd-brand-link text-decoration-none me-2">
                  <span class="pd-brand-badge">
                  <i class="fa-solid fa-tag"></i>
                  </span>
                    <span class="pd-brand-text"
                          th:text="${product.brandName}">
                  Brand
                  </span>
                </a>
                <!-- TITLE -->
                <h2 class="mb-0" th:text="${product.title}">Product Title</h2>
                <!-- OFFER BADGE -->
                <span class="badge-discount"
                      th:if="${product.finalPrice != null and product.originalPrice != null and product.finalPrice < product.originalPrice}">
                  <i class="fa-solid fa-bolt-lightning"></i>
                  <span th:text="${#numbers.formatDecimal((product.originalPrice - product.finalPrice) * 100 / product.originalPrice, 0, 0)} + '% OFF'">
                  10% OFF
                  </span>
                  </span>
            </div>
            <p class="text-muted mb-1" th:text="${product.categoryName != null ? 'Category: ' + product.categoryName : 'Category: N/A'}"></p>
            <div class="mb-3">
                <!-- LINE 1: small ₹ + big main price -->
                <div class="pd-price-main">
                    <span class="pd-price-currency">₹</span>
                    <!-- store numeric price in data attribute, formatted by JS on load -->
                    <span class="pd-price-current"
                          th:attr="data-price=${product.finalPrice != null
                        ? product.finalPrice
                        : (product.originalPrice != null
                        ? product.originalPrice
                        : (product.discountPrice != null
                        ? product.discountPrice
                        : (product.price != null ? product.price : 0.00)))}">0.00</span>
                </div>
                <!-- LINE 2: original price + savings text -->
                <div class="pd-price-extra">
                     <span class="pd-price-original" th:if="${product.originalPrice != null and product.finalPrice != null and product.finalPrice < product.originalPrice}">
                     <span class="pd-price-currency small-currency">₹</span>
                     <span th:attr="data-price-original=${product.originalPrice}">0.00</span>
                     </span>
                    <span class="pd-price-save" th:if="${product.offerDiscount != null && product.offerDiscount > 0}"
                          th:text="${'(You save ₹ ' + product.offerDiscount + ')'}">(You save ₹ 0.00)</span>
                </div>
                <p class="text-success fw-semibold" th:if="${product.appliedScope == T(com.hyperchip.common.dto.OfferScope).PRODUCT}">Product offer applied</p>
                <p class="text-success fw-semibold" th:if="${product.appliedScope == T(com.hyperchip.common.dto.OfferScope).CATEGORY}">Category offer applied</p>
                <p class="text-muted small" th:if="${product.appliedScope == T(com.hyperchip.common.dto.OfferScope).NONE or product.appliedScope == null}">No offer applied</p>
            </div>
            <p class="mb-3" th:if="${product.stock != null}" th:text="${product.stock > 0 ? 'In stock: ' + product.stock : 'Sold Out'}">Stock</p>
            <div class="mb-4 d-flex gap-2 align-items-center">
                <input type="number" id="pd-qty" min="1" max="10" value="1" class="form-control" style="width:110px;"/>
                <button id="btn-add-to-cart" class="btn btn-warning btn-lg"
                        th:classappend="${(product.stock != null and product.stock == 0) or (product.active == null or !product.active)} ? ' disabled' : ''"
                        th:attr="data-product-id=${product.id}">
                    <i class="fa-solid fa-cart-plus me-1"></i> <span id="addToCartLabel">Add to Cart</span>
                </button>
                <button id="btn-add-to-wishlist" class="btn btn-outline-danger btn-lg"
                        th:classappend="${(product.active == null or !product.active)} ? ' disabled' : ''"
                        th:attr="data-product-id=${product.id}">
                    <i class="fa-solid fa-heart"></i> Wishlist
                </button>
            </div>
            <div class="border rounded p-3 bg-white txt-black">
                <h6 class="mb-2">Product Details</h6>
                <p class="small mb-0" th:text="${product.description != null ? product.description : 'No description.'}"></p>
            </div>
        </div>
    </div>
    <!-- SINGLE TAB: Overview only -->
    <div class="mt-5">
        <h2>Overview</h2>
        <div class="tab-content p-3 border border-top-0">
            <div class="tab-pane fade show active" id="overview">
                <p th:text="${product.description != null ? product.description : 'Product description here.'}">Product description here.</p>
            </div>
        </div>
    </div>
    <!-- Related -->
    <div class="mt-5" th:if="${relatedProducts != null and !#lists.isEmpty(relatedProducts)}">
        <h4>Related Products</h4>
        <div class="row g-3">
            <div class="col-sm-6 col-md-3" th:each="relProd : ${relatedProducts}">
                <div class="card h-100 shadow-sm">
                    <img th:if="${relProd.imageNames != null and !#lists.isEmpty(relProd.imageNames)}"
                         th:src="${masterBaseUrl + '/uploads/products/' + relProd.imageNames[0]}"
                         class="card-img-top" th:alt="${relProd.title}" />
                    <img th:if="${relProd.imageNames == null or #lists.isEmpty(relProd.imageNames)}"
                         th:src="@{/img/default-product.png}" class="card-img-top" alt="No Image Available" />
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title hc-related-title" th:text="${relProd.title != null ? relProd.title : 'Product Name'}">Product Name</h6>
                        <!-- price with offer: rupee symbol + numeric value in data-price -->
                        <div class="d-flex flex-column related-product">
                            <div>
                              <span class="text-primary fw-bold">
                              <span class="pd-price-currency">₹</span>
                              <span class="rel-price-value"
                                    th:attr="data-price=${relProd.finalPrice != null
                                 ? relProd.finalPrice
                                 : (relProd.originalPrice != null
                                 ? relProd.originalPrice
                                 : (relProd.discountPrice != null
                                 ? relProd.discountPrice
                                 : (relProd.price != null ? relProd.price : 0.00)))}">0.00</span>
                              </span>
                                <small class="text-muted text-decoration-line-through"
                                       th:if="${relProd.originalPrice != null and relProd.finalPrice != null and relProd.finalPrice < relProd.originalPrice}">
                                    <span class="pd-price-currency small-currency">₹</span>
                                    <span th:attr="data-price-original=${relProd.originalPrice}">0.00</span>
                                </small>
                            </div>
                            <a th:href="@{/user/product/{id}(id=${relProd.id})}" class="btn btn-outline-dark mt-3">View Details</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="fragments/user-footer :: userFooter"></div>
<!-- Modal for big image -->
<div class="modal fade" id="bigImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="bigImage" src="" class="img-fluid w-100" alt="Large view">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- External scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/drift-zoom/dist/Drift.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Consolidated behavior script (single DOMContentLoaded) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize image zoom (Drift) if available
        try {
            new Drift(document.getElementById('mainProductImage'), {
                paneContainer: document.getElementById('zoomContainer'),
                inlinePane: true,
                hoverBoundingBox: true
            });
        } catch(e) { /* ignore if Drift not available */ }

        // Server-side flags (Thymeleaf inline expressions)
        var signedIn = /*[[${session.currentUser != null}]]*/ false;
        var userId = /*[[${session.currentUser != null ? session.currentUser.id : -1}]]*/ -1;
        var authLoginUrl = /*[[${@environment.getProperty('auth.service.login.url') != null ? @environment.getProperty('auth.service.login.url') : '/login'}]]*/ '/login';

        // number formatting: Indian system (lakhs/crores) with two decimals
        function formatIndianNumber(num){
            if(num === null || num === undefined) return '0.00';
            var n = Number(num);
            if(isNaN(n)) return num;
            // keep two decimals
            var parts = n.toFixed(2).split('.');
            var intPart = parts[0];
            var decPart = parts[1];
            if(intPart.length <= 3) {
                return intPart + '.' + decPart;
            }
            var last3 = intPart.slice(-3);
            var rest = intPart.slice(0, -3);
            rest = rest.replace(/\B(?=(\d{2})+(?!\d))/g, ",");
            return rest + ',' + last3 + '.' + decPart;
        }

        // Format main product price(s)
        document.querySelectorAll('[data-price]').forEach(function(el){
            var raw = el.getAttribute('data-price');
            if(raw == null) raw = el.textContent;
            el.textContent = formatIndianNumber(raw);
        });
        document.querySelectorAll('[data-price-original]').forEach(function(el){
            var raw = el.getAttribute('data-price-original');
            el.textContent = formatIndianNumber(raw);
        });

        // Helper: update nav cart badge
        function updateNavBadge(total) {
            try {
                var badge = document.getElementById('nav-cart-count');
                if (!badge) return;
                badge.innerText = Number(total || 0);
                if (Number(total || 0) === 0) badge.classList.add('visually-hidden'); else badge.classList.remove('visually-hidden');
            } catch (e) { /* ignore */ }
        }

        // === Add to Cart handler ===
        (function attachAddToCart(){
            var btn = document.getElementById('btn-add-to-cart');
            if (!btn) return;

            btn.addEventListener('click', async function (ev) {
                ev.preventDefault();
                if (btn.classList.contains('disabled')) return;

                var pid = btn.getAttribute('data-product-id');
                var qtyEl = document.getElementById('pd-qty');
                var qty = qtyEl ? Math.max(1, Math.min(10, parseInt(qtyEl.value || '1'))) : 1;

                if (!signedIn || userId === -1) {
                    var redirectBack = window.location.pathname + window.location.search;
                    window.location.href = authLoginUrl + '?redirect=' + encodeURIComponent(redirectBack);
                    return;
                }

                try {
                    var payload = { userId: parseInt(userId), productId: parseInt(pid), quantity: parseInt(qty) };
                    var res = await fetch('/user/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        let errText = 'Could not add to cart';
                        try {
                            const json = await res.json();
                            if (json && json.error) errText = json.error;
                            else if (json && json.message) errText = json.message;
                        } catch (e) { errText = res.statusText || errText; }
                        Swal.fire({ icon: 'error', title: 'Add to cart failed', text: errText, confirmButtonColor: '#f3a111' });
                        return;
                    }

                    const body = await res.json();

                    Swal.fire({
                        icon: 'success',
                        title: 'Added to cart',
                        text: 'Item added to your cart',
                        timer: 1200,
                        showConfirmButton: false
                    });

                    if (body && body.totalItems != null) updateNavBadge(body.totalItems);

                } catch (err) {
                    console.error('Add to cart error', err);
                    Swal.fire({ icon: 'error', title: 'Network error', text: 'Could not contact server. Try again later.' });
                }
            });
        })();

        // === Wishlist handler with client-side limit check (max 3) ===
        (function attachWishlist(){
            var wishlistBtn = document.getElementById('btn-add-to-wishlist');
            if (!wishlistBtn) return;

            wishlistBtn.addEventListener('click', async function(ev){
                ev.preventDefault();
                if (wishlistBtn.classList.contains('disabled')) return;
                var pid = wishlistBtn.getAttribute('data-product-id');

                if (!signedIn || userId === -1) {
                    var redirectBack = window.location.pathname + window.location.search;
                    window.location.href = authLoginUrl + '?redirect=' + encodeURIComponent(redirectBack);
                    return;
                }

                try {
                    // Try to read wishlist count first
                    var currentCount = null;
                    try {
                        const currentResp = await fetch('/user/api/wishlist/' + encodeURIComponent(userId), {
                            method: 'GET',
                            credentials: 'same-origin',
                            headers: { 'Accept': 'application/json' }
                        });
                        if (currentResp.ok) {
                            const parsed = await currentResp.json();
                            const items = Array.isArray(parsed) ? parsed : (parsed.items || []);
                            currentCount = Array.isArray(items) ? items.length : 0;
                        } else {
                            console.warn('Could not read wishlist (status ' + currentResp.status + '), will attempt add and rely on server.');
                        }
                    } catch (e) {
                        console.warn('Failed to fetch wishlist for limit check', e);
                    }

                    if (currentCount != null && currentCount >= 3) {
                        Swal.fire({ icon: 'warning', title: 'Limit reached', text: 'You can keep a maximum of 3 items in wishlist.', timer: 1600, showConfirmButton: false });
                        return;
                    }

                    var url = '/user/api/wishlist/' + encodeURIComponent(userId) + '/items/' + encodeURIComponent(pid);
                    var res = await fetch(url, { method: 'POST', credentials: 'same-origin', headers: { 'Accept': 'application/json' } });

                    if (!res.ok) {
                        var text = await res.text().catch(()=>res.statusText);
                        try {
                            var j = JSON.parse(text);
                            var err = j.error || j.message || text;
                            Swal.fire({ icon: 'error', title: 'Wishlist error', text: String(err) });
                        } catch(e){
                            var lower = (text || '').toLowerCase();
                            if (lower.includes('limit') || lower.includes('maximum')) {
                                Swal.fire({ icon: 'warning', title: 'Limit reached', text: 'You can keep a maximum of 3 items in wishlist.' });
                            } else {
                                Swal.fire({ icon: 'error', title: 'Wishlist error', text: text || res.statusText });
                            }
                        }
                        console.warn('wishlist add failed', res.status, text);
                        return;
                    }

                    Swal.fire({ icon: 'success', title: 'Added to wishlist', timer: 900, showConfirmButton: false });
                    setTimeout(()=> window.location.href = '/user/wishlist', 800);

                } catch (err) {
                    console.error('Wishlist error', err);
                    Swal.fire({ icon: 'error', title: 'Could not add to wishlist', text: err.message || 'Network error' });
                }
            });
        })();

    }); // DOMContentLoaded
    /*]]>*/
</script>
<!-- Thumbnail switcher -->
<script>
    function updateMainImage(el) {
      var main = document.getElementById('mainProductImage');
      if (main && el && el.src) {
        main.src = el.src;
        document.querySelectorAll('.thumb-img').forEach(function(t){ t.classList.remove('active'); });
        el.classList.add('active');
      }
    }
</script>
</body>
</html>